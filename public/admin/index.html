<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin | TikTok Automation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body{margin:0;background:#f6f9ff}
        .header{height:60px;background:#fff;border-bottom:1px solid #eaeaea;
            position:fixed;top:0;left:0;right:0;z-index:1000;
            display:flex;align-items:center;padding:0 24px}
        .sidebar{position:fixed;top:60px;left:0;bottom:0;width:260px;
            background:#fff;border-right:1px solid #eaeaea;padding:16px}
        .sidebar a{display:block;padding:10px 12px;border-radius:8px;
            color:#012970;text-decoration:none;font-weight:600;margin-bottom:6px}
        .sidebar a.active,.sidebar a:hover{background:#4154f1;color:#fff}
        .main{margin-left:260px;padding:90px 30px}
        .footer{margin-left:260px;padding:20px;border-top:1px solid #eaeaea;
            color:#6c757d;font-size:14px;text-align:center}
    </style>
</head>

<body>

<div class="header">
    <div class="fw-bold text-primary fs-5">TikTok Automation</div>
    <div class="ms-auto dropdown">
        <a href="#" class="fw-semibold text-decoration-none dropdown-toggle"
           data-bs-toggle="dropdown">
            <i class="bi bi-person-circle me-1"></i> Admin
        </a>
        <ul class="dropdown-menu dropdown-menu-end">
            <li>
                <a class="dropdown-item text-danger" href="#" id="btnLogout">
                    <i class="bi bi-box-arrow-right me-2"></i> Đăng xuất
                </a>
            </li>
        </ul>
    </div>
</div>

<aside class="sidebar">
    <a href="/admin/dashboard" data-view="dashboard">Dashboard</a>
    <a href="/admin/tiktok" data-view="tiktok">TikTok Accounts</a>
    <a href="/admin/send" data-view="send">Send Message</a>
    <a href="/admin/schedule" data-view="schedule">Schedule</a>
    <a href="/admin/history" data-view="history">History</a>
</aside>

<main class="main">
    <div id="app"></div>
</main>

<div class="footer">© TikTok Automation</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /* ===== API FETCH (FIX 401) ===== */
    function apiFetch(url, options = {}) {
        return fetch(url, { credentials: "include", ...options });
    }

    /* ===== AUTH GUARD ===== */
    async function authGuard(){
        const r = await apiFetch("/api/tiktok/list");
        if(!r.ok){
            location.href="/admin/login.html";
            return false;
        }
        return true;
    }

    /* ===== ROUTER ===== */
    const VIEWS=["dashboard","tiktok","send","schedule","history"];

    function getView(){
        const p = location.pathname.split("/").filter(Boolean)[1];
        return VIEWS.includes(p)?p:"dashboard";
    }

    async function loadView(view,push=true){
        if(!await authGuard()) return;
        const r = await fetch(`/admin/views/${view}.html`);
        document.getElementById("app").innerHTML = await r.text();
        document.querySelectorAll("[data-view]").forEach(a=>{
            a.classList.toggle("active",a.dataset.view===view);
        });
        if(push) history.pushState({view},"",`/admin/${view}`);
    }

    document.addEventListener("click",e=>{
        const a=e.target.closest("[data-view]");
        if(!a) return;
        e.preventDefault();
        loadView(a.dataset.view,true);
    });

    window.onpopstate=e=>{
        loadView(e.state?.view||getView(),false);
    };

    document.getElementById("btnLogout").onclick=()=>{
        document.cookie="admin_token=; Max-Age=0; path=/";
        location.href="/admin/login.html";
    };

    loadView(getView(),false);
</script>

</body>
</html>
